<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <style>
    /* Allgemeines Styling */
    body {
      margin: 0;
      font-family: "Roboto", sans-serif;
      background-color: white;
      color: black;
    }

    /* Header Styling */
    header {
      position: fixed;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 150px;
      background-color: #ffffff;
      width: 100%;
      top: 0;
      left: 0;
    }
    .menu-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      position: absolute;
      left: 20px;
      transition: transform 0.3s ease-in-out;
    }
    .menu-toggle span {
      background: black;
      height: 2px;
      width: 25px;
      margin: 3px 0;
    }
    .header-center img {
      max-height: 100px;
    }
    .header-icons {
      display: flex;
      gap: 15px;
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }
    .header-icons img {
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    /* Navigation */
    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      margin-top: 150px; /* damit das Menü nicht unter dem Header liegt */
    }
    nav a {
      color: black;
      text-decoration: none;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: 300;
      font-family: "Roboto", sans-serif;
      position: relative;
    }
    nav a::after {
      content: "";
      display: block;
      width: 0;
      height: 3px;
      background: black;
      transition: width 0.3s ease-in-out;
      position: absolute;
      bottom: -5px;
      left: 0;
    }
    nav a:hover::after {
      width: 100%;
    }

    /* Hauptcontainer für Checkout */
    .checkout-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }

    /* Formular-Bereich */
    .checkout-form {
      flex: 1 1 300px;
      min-width: 280px;
    }
    .checkout-form h2 {
      margin-bottom: 10px;
    }
    .checkout-form form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .checkout-form label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
    }
    .checkout-form input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Zusammenfassung */
    .checkout-summary {
      flex: 1 1 300px;
      min-width: 280px;
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      height: fit-content;
    }
    .checkout-summary h2 {
      margin-top: 0;
    }
    .checkout-summary p {
      margin: 5px 0;
    }
    .checkout-summary .summary-items {
      margin: 15px 0;
      border-top: 1px solid #ccc;
      padding-top: 15px;
    }
    .checkout-summary button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="menu-toggle" onclick="openMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="header-center">
      <img src="logo.png" alt="Logo" />
    </div>
    <div class="header-icons">
      <img src="suchen.png" alt="Search" id="search-icon" />
      <a href="cart.html">
        <img src="wk.png" alt="Cart" />
      </a>
    </div>
  </header>

  <!-- Navigation -->
  <nav>
    <a href="index.html">Home</a>
    <a href="#">Gallery</a>
    <a href="#">Pages</a>
    <a href="#">Blog</a>
    <a href="#">About</a>
    <a href="#">Contact</a>
  </nav>

  <!-- Hauptbereich -->
  <div class="checkout-container">
    <!-- Formular-Bereich -->
    <div class="checkout-form">
      <h2>Rechnungs- & Lieferdaten</h2>
      <form id="checkoutForm">
        <label>
          Vorname:
          <input type="text" name="vorname" required />
        </label>
        <label>
          Nachname:
          <input type="text" name="nachname" required />
        </label>
        <label>
          Strasse:
          <input type="text" name="strasse" required />
        </label>
        <label>
          Hausnummer:
          <input type="text" name="hausnummer" required />
        </label>
        <label>
          Stadt:
          <input type="text" name="stadt" required />
        </label>
        <label>
          Land:
          <input type="text" name="land" required />
        </label>
      </form>
    </div>

    <!-- Zusammenfassung-Bereich -->
    <div class="checkout-summary">
      <h2>Bestellübersicht</h2>
      <div id="summary-items" class="summary-items">
        <!-- Hier werden die Produkte aus dem Warenkorb aufgelistet -->
      </div>
      <p id="summary-total">Gesamt: 0,00 €</p>
      <button onclick="submitOrder()">Bestellung abschließen</button>
    </div>
  </div>

  <script>
    // 1) Warenkorb aus Local Storage laden und anzeigen
    function loadCartSummary() {
      const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
      const summaryItems = document.getElementById('summary-items');
      const summaryTotal = document.getElementById('summary-total');
  
      summaryItems.innerHTML = '';
      let gesamtpreis = 0;
  
      cartItems.forEach((item) => {
        const preisNum = parseFloat(item.preis) || 0;
        const zeilenPreis = preisNum * item.menge;
        gesamtpreis += zeilenPreis;
  
        const itemDiv = document.createElement('div');
        itemDiv.style.marginBottom = '10px';
        itemDiv.innerHTML = `
          <strong>${item.name}</strong><br>
          ${item.menge} x ${preisNum.toFixed(2)} € = ${zeilenPreis.toFixed(2)} €
        `;
        summaryItems.appendChild(itemDiv);
      });
  
      summaryTotal.textContent = 'Gesamt: ' + gesamtpreis.toFixed(2) + ' €';
    }
  
    // 2) Bestellung abschicken -> Daten an Airtable senden

    const AIRTABLE_API_KEY = "patoJ0rbjGUzWuwKG.d2458e18c3f777dc341a8ff90fc66d55457ff3cafb219efbd82fa7575b05aaf9";
const BASE_ID = "appJ5tDISO3meA1Sf";
const ORDERS_TABLE = "Orders";
const PRODUCTS_TABLE = "Produkte";

async function submitOrder() {
  const form = document.getElementById('checkoutForm');
  const formData = new FormData(form);

  const customerData = {
    vorname: formData.get('vorname'),
    nachname: formData.get('nachname'),
    strasse: formData.get('strasse'),
    hausnummer: formData.get('hausnummer'),
    stadt: formData.get('stadt'),
    land: formData.get('land')
  };

  const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
  const cartItemsString = JSON.stringify(cartItems);

  try {
    const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${ORDERS_TABLE}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${AIRTABLE_API_KEY}`
        },
        body: JSON.stringify({
          records: [
            {
              fields: {
                Vorname: customerData.vorname,
                Nachname: customerData.nachname,
                Strasse: customerData.strasse,
                Hausnummer: customerData.hausnummer,
                Stadt: customerData.stadt,
                Land: customerData.land,
                ProductID: cartItemsString
              }
            }
          ]
        })
      });

    if (!response.ok) {
      throw new Error('Fehler beim Anlegen des Datensatzes in Airtable');
    }

    await updateStock(cartItems);

    localStorage.removeItem('cartItems');
    loadCartSummary();
    alert('Bestellung erfolgreich abgeschickt!');
  } catch (error) {
    console.error('Fehler:', error);
    alert('Beim Abschicken der Bestellung ist ein Fehler aufgetreten.');
  }
}

async function updateStock(cartItems) {
  for (const item of cartItems) {
    const produktID = item.id;
    const menge = item.menge;

    const productResponse = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PRODUCTS_TABLE}/${produktID}`, {
      headers: {
        Authorization: `Bearer ${AIRTABLE_API_KEY}`
      }
    });

    if (!productResponse.ok) {
      console.error(`Fehler beim Abrufen des Produkts mit ID ${produktID}`);
      continue;
    }

    const productData = await productResponse.json();
    if (!productData.id) {
      console.error(`Kein Produkt mit ID ${produktID} gefunden`);
      continue;
    }

    const newStock = (productData.fields.Lagerbestand || 0) - menge;

    await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PRODUCTS_TABLE}/${produktID}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${AIRTABLE_API_KEY}`
      },
      body: JSON.stringify({ fields: { Lagerbestand: newStock } })
    });
  }
}


  
    // Beim Laden der Seite direkt Warenkorb zusammenfassen
    window.addEventListener('DOMContentLoaded', loadCartSummary);
  </script>
  
</body>
</html>
